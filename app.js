// Generated by CoffeeScript 1.8.0
var async, asyncParallelRequests, fs, logger, monitorInterval, monitorSeeds, path, seed, visitor;

path = require("path");

fs = require("fs");

global.rootRequire = function(name) {
  return require(path.join(__dirname, name));
};

logger = require('winston');

logger.add(logger.transports.File, {
  filename: '/tmp/ebuy_monitor.log'
});

global.logger = logger;

async = require("async");

seed = rootRequire("src/seed.js");

visitor = rootRequire("src/visitor.js");

monitorInterval = rootRequire("src/config.js").monitorInterval;

monitorSeeds = JSON.parse(fs.readFileSync(path.join(__dirname, "monitor.json"))).map(function(item) {
  return seed(item.id, item.site);
});

asyncParallelRequests = function() {
  async.parallel(monitorSeeds.map(function(seed) {
    return function() {
      var v;
      v = visitor.select(seed.siteUrl);
      v.visit(seed.url);
    };
  }), function(err) {
    console.log(err);
  });
};

setInterval(asyncParallelRequests, monitorInterval);
