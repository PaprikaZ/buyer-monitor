// Generated by CoffeeScript 1.8.0
var argvParser, fs, launchMonitor, logger, path;

path = require("path");

fs = require("fs");

global.rootRequire = function(name) {
  return require(path.join(__dirname, name));
};

logger = require('winston');

logger.add(logger.transports.File, {
  filename: '/tmp/ebuy_monitor.log'
});

global.logger = logger;

launchMonitor = function() {
  var async, asyncParallelRequests, monitorInterval, monitorSeeds, seed, visitor;
  seed = rootRequire("src/seed.js");
  monitorSeeds = JSON.parse(fs.readFileSync(path.join(__dirname, "product.json"))).map(function(item) {
    return seed(item.id, item.site);
  });
  async = require("async");
  visitor = rootRequire("src/visitor.js");
  asyncParallelRequests = function() {
    async.parallel(monitorSeeds.map(function(seed) {
      return function() {
        var v;
        v = visitor.select(seed.siteUrl);
        v.visit(seed.url);
      };
    }), function(err) {
      console.log(err);
    });
  };
  monitorInterval = rootRequire("src/config.js").monitorInterval;
  return setInterval(asyncParallelRequests, monitorInterval);
};

argvParser = rootRequire("src/argv_parser.js");

argvParser.parse(process.argv.slice(2), launchMonitor);
