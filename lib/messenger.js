// Generated by CoffeeScript 1.8.0
var Messenger, accessTokens, assembleMessengeBody, assembleMessengeTitle, config, request, util;

util = require('util');

request = require('request');

config = require('./config.js');

accessTokens = config.accounts.map(function(account) {
  return account.accessToken;
});

assembleMessengeTitle = function(result) {
  var title;
  title = util.format("id %s on site %s meet your requirement", result.id, result.site);
  return title;
};

assembleMessengeBody = function(result) {
  var body;
  body = util.format("Title: %s\n", result.title);
  body += util.format("Url: %s\n", result.url);
  body += util.format("Price: %s        full price: %s\n", result.price, result.fullPrice);
  body += util.format("Discount: %s\% OFF\n", Math.round(result.discount));
  body += util.format("Review: %s\n", result.review);
  body += util.format("Instore: %s\n", typeof result.instore === "function" ? result.instore({
    "yes": "no"
  }) : void 0);
  if (0 < result.benefits.length) {
    result.benefits.forEach(function(benefit, idx) {
      body += util.format("Benefit%s: %s\n", idx, benefit);
    });
  } else {
    body += "Benefits: none\n";
  }
  return body;
};

Messenger = (function() {
  function Messenger() {}

  Messenger.prototype.push = function(result) {
    var messenge, self;
    self = this;
    logger.debug("id %s site %s to be pushed", result.id, result.site);
    messenge = {
      type: 'note',
      title: assembleMessengeTitle(result),
      body: assembleMessengeBody(result)
    };
    accessTokens.map(function(token) {
      var postOptions, shortToken;
      shortToken = token.slice(0, 7);
      postOptions = {
        url: config.pushServiceUrl,
        auth: {
          user: token
        },
        headers: {
          'content-type': 'application/json'
        },
        body: JSON.stringify(messenge)
      };
      return request.post(postOptions, function(err, res, body) {
        if (!err && res.statusCode === 200) {
          logger.info("push message to user %s ok.", shortToken);
        } else if (!err && res.statusCode !== 200) {
          self.errorResponseHandler(shortToken, err, res, body);
        } else {
          self.failedRequestHandler(shortToken, err, res, body);
        }
      });
    });
  };

  Messenger.prototype.errorResponseHandler = function(token, err, res, body) {
    logger.warn("messenger response error.");
    logger.warn("token %s response status code: %s", token, res.statusCode);
    logger.warn("token %s body: %s", token, body);
  };

  Messenger.prototype.failedRequestHandler = function(token, err, res, body) {
    logger.error("messenger request failed.");
    logger.error("token %s, error %s", token, err);
  };

  return Messenger;

})();

module.exports = Messenger;
