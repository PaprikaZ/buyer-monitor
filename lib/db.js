// Generated by CoffeeScript 1.8.0
var config, mongoClient, mongoErrorRethrow, mongoose, redis, redisClient, redisErrorRethrow;

redis = require('redis');

mongoose = require('mongoose');

config = require('./config.js');

redisClient = null;

redisErrorRethrow = function(err) {
  logger.error('redis caught error');
  logger.error('msg: %s', err.message);
  throw err;
};

exports.connectRedis = function() {
  redisClient = redis.createClient(config.redisPort, config.redisHost);
  redisClient.select(config.redisDBIndex, function(err, res) {
    if (err) {
      logger.error('redis select %s failed', config.redisDBIndex);
      redisErrorRethrow(err);
    } else {
      logger.debug('redis select %s %s', config.redisDBIndex, res);
    }
  });
  redisClient.on('error', function(err) {
    redisErrorRethrow(err);
  });
};

exports.getRedisClient = function() {
  if (redisClient) {
    return redisClient;
  } else {
    logger.debug('redis client should be created just after monitor launched');
    throw new Error('redis client not initialized');
  }
};

exports.clearQueue = function() {
  return redisClient.flushdb();
};

exports.redisErrorRethrow = redisErrorRethrow;

mongoClient = null;

mongoErrorRethrow = function(err) {
  logger.error('mongo caught error');
  logger.error('msg: %s', err.message);
  throw err;
};

exports.connectMongoDB = function() {
  return mongoose.connect(config.mongoDBUrl, config.mongoConnectionOptions);
};

exports.getMongoClient = function() {
  if (mongoClient) {
    return mongoClient;
  } else {
    logger.debug('mongo client should be created just adter monitor launched');
    throw new Error('mongo db client not initialized');
  }
};

exports.mongoErrorRethrow = mongoErrorRethrow;

module.exports = exports;
